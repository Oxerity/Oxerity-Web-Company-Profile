name: Auto Deploy Laravel via SSH Key

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy via SSH (Using Private Key)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}

          script: |
            echo "‚û°Ô∏è Start deployment..."

            # ===== FIX npm not found (NVM path) =====
            export NVM_DIR="/home/${{ secrets.SERVER_USER }}/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            nvm use 22

            cd ${{ secrets.SERVER_PATH }}

            echo "‚û°Ô∏è Pulling latest code..."
            git pull origin main

            echo "‚û°Ô∏è Installing composer dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader

            echo "‚û°Ô∏è Clearing Laravel cache..."
            php artisan optimize:clear

            echo "‚û°Ô∏è Running migrations..."
            php artisan migrate --force

            echo "‚û°Ô∏è Rebuilding Laravel cache..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "‚û°Ô∏è Building frontend..."
            npm install --no-audit --no-fund
            npm run build

            echo "‚û°Ô∏è Restarting queue workers..."
            php artisan queue:restart

            echo "üöÄ Deployment completed successfully!"
